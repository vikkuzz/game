# Документация игры "Survival Chaos"

## Содержание
1. [Общее описание](#общее-описание)
2. [Игровая механика](#игровая-механика)
3. [Игроки и начальные условия](#игроки-и-начальные-условия)
4. [Типы юнитов](#типы-юнитов)
5. [Типы зданий](#типы-зданий)
6. [Боевая система](#боевая-система)
7. [Движение юнитов](#движение-юнитов)
8. [Экономика](#экономика)
9. [Система улучшений](#система-улучшений)
10. [Автоматическое развитие](#автоматическое-развитие)
11. [Искусственный интеллект](#искусственный-интеллект)
12. [Условия победы](#условия-победы)

---

## Общее описание

**Survival Chaos** — это стратегическая игра в реальном времени (RTS), в которой участвуют 4 игрока на квадратной карте размером 800x800 пикселей. Цель игры — уничтожить все здания и юниты противников, став последним выжившим игроком.

### Ключевые особенности:
- Реальное время: игра работает в непрерывном игровом цикле (50мс на кадр)
- 4 игрока: один человеческий (ID: 0) и три управляемых ИИ (ID: 1, 2, 3)
- Управление ресурсами: золото, которое используется для покупки юнитов и улучшений
- Автоматический спавн: бараки автоматически создают юнитов через определенные интервалы
- Система улучшений: улучшение характеристик юнитов, зданий и экономики

---

## Игровая механика

### Игровой цикл

Игра работает на основе `requestAnimationFrame` с интервалом обновления **50 миллисекунд** (20 кадров в секунду):

1. **Обновление движения** — юниты перемещаются к целям
2. **Разделение юнитов** — юниты отталкиваются друг от друга для предотвращения наложения
3. **Боевые действия:**
   - Атаки между юнитами
   - Атаки зданий по юнитам
   - Атаки юнитов по зданиям
4. **Спавн юнитов** — бараки создают новых юнитов
5. **Начисление золота** — игроки получают пассивный доход
6. **Обновление кулдаунов** — таймеры улучшений и починки зданий
7. **Проверка условий победы**

### Игровое состояние

```typescript
interface GameState {
  players: Player[];           // Массив из 4 игроков
  gameTime: number;            // Время игры в секундах
  isPaused: boolean;           // Игра на паузе
  gameSpeed: number;           // Множитель скорости (1.0 = нормальная)
  selectedPlayer: PlayerId;    // Выбранный игрок (для UI)
  selectedBuilding: string;    // Выбранное здание (для UI)
  gameOver: boolean;           // Игра окончена
  winner: PlayerId | null;     // ID победителя (null = ничья)
  autoUpgrade: boolean;        // Авторазвитие для игрока 0
}
```

---

## Игроки и начальные условия

### Расположение игроков

Начальные позиции игроков расположены в центре каждой стороны квадратной карты:

- **Игрок 0** (Верхний): `x = 400, y = 120` — управляется человеком
- **Игрок 1** (Правый): `x = 680, y = 400`
- **Игрок 2** (Нижний): `x = 400, y = 680`
- **Игрок 3** (Левый): `x = 120, y = 400`

### Начальные ресурсы

Каждый игрок начинает с:
- **500 золота**
- **10 золота в секунду** (пассивный доход)
- **1 замок** (главное здание)
- **3 барака** (создают юнитов)
- **6 башен** (защитные сооружения)
- **0 юнитов**

### Структура игрока

```typescript
interface Player {
  id: PlayerId;              // 0, 1, 2 или 3
  gold: number;              // Текущее золото
  goldIncome: number;        // Золото в секунду
  castle: Building;          // Главное здание
  barracks: Building[];      // Массив бараков (3 шт)
  towers: Building[];        // Массив башен (6 шт)
  units: Unit[];             // Все юниты игрока
  upgrades: CastleUpgrades;  // Улучшения характеристик
  isActive: boolean;         // Игрок еще жив
  stats: PlayerStats;        // Статистика боя
}
```

---

## Типы юнитов

В игре существует **3 типа юнитов**, каждый со своими характеристиками:

### 1. Воин (Warrior) — ближний бой
- **Здоровье**: 100 HP (базовое)
- **Атака**: 20 урона (базовое)
- **Защита**: 10 (базовое)
- **Скорость**: 30 пикселей/сек
- **Радиус атаки**: 50 пикселей (ближний бой)
- **Стоимость**: 50 золота
- **Особенность**: Подходит вплотную к врагу (35px) для атаки

### 2. Лучник (Archer) — дальний бой
- **Здоровье**: 60 HP (базовое)
- **Атака**: 25 урона (базовое)
- **Защита**: 5 (базовое)
- **Скорость**: 35 пикселей/сек
- **Радиус атаки**: 180 пикселей (дальний бой)
- **Стоимость**: 75 золота
- **Особенность**: Останавливается на оптимальной дистанции (60% от радиуса = 108px)

### 3. Маг (Mage) — дальний бой
- **Здоровье**: 50 HP (базовое)
- **Атака**: 30 урона (базовое)
- **Защита**: 3 (базовое)
- **Скорость**: 25 пикселей/сек
- **Радиус атаки**: 100 пикселей (средний дальний бой)
- **Стоимость**: 100 золота
- **Особенность**: Останавливается на оптимальной дистанции (60% от радиуса = 60px)

### Модификаторы улучшений

Характеристики юнитов увеличиваются в зависимости от уровня улучшений игрока:

- **Атака**: `базовая_атака * (1 + уровень_атаки * 0.1)` — +10% за уровень
- **Защита**: `базовая_защита * (1 + уровень_защиты * 0.1)` — +10% за уровень
- **Здоровье**: `базовое_здоровье * (1 + уровень_здоровья * 0.15)` — +15% за уровень

### Награды за убийство

- Воин: **15 золота**
- Лучник: **20 золота**
- Маг: **25 золота**

---

## Типы зданий

### 1. Замок (Castle) — главное здание

**Начальные характеристики:**
- **Здоровье**: 2000 HP
- **Максимальное здоровье**: 2000 HP
- **Урон**: 20
- **Радиус атаки**: 50 пикселей
- **Защита**: 15
- **Уровень**: 1

**Особенности:**
- Главное здание игрока — если разрушено, игрок выбывает
- Может атаковать вражеских юнитов в радиусе 50px
- Интервал атаки: **1 секунда**
- Может быть улучшен до уровня 2 (стоимость: 200 золота)

**Награда за разрушение**: 500 золота (разделяется между всеми атакующими игроками)

### 2. Барак (Barracks) — создание юнитов

**Начальные характеристики:**
- **Здоровье**: 1000 HP
- **Максимальное здоровье**: 1000 HP
- **Защита**: 10
- **Уровень**: 1
- **Доступные юниты**: 5
- **Максимум доступных юнитов**: 5

**Расположение:**
- 1 центральный барак (направлен к центру карты)
- 2 боковых барака (направлены к соседним игрокам)

**Функции:**
- **Автоматический спавн**: каждые 15 секунд создает юнита типа, зависящего от уровня:
  - Уровень 1: Воин
  - Уровень 2: Лучник
  - Уровень 3: Маг
  - Выше: зависит от уровня барака
  
- **Покупка юнитов**: игрок может купить дополнительные юниты:
  - Воин: 50 золота
  - Лучник: 75 золота
  - Маг: 100 золота
  - Восстановление доступных юнитов: 5 секунд на единицу

**Улучшение:**
- Стоимость: `уровень * 200` золота
- Каждый уровень:
  - +100 HP к максимальному здоровью
  - +2 к максимуму доступных юнитов
  - -10% ко времени спавна (минимум 7.5 секунд)
- Кулдаун улучшения: 5 секунд

**Награда за разрушение**: 150 золота

### 3. Башня (Tower) — защита

**Начальные характеристики:**
- **Здоровье**: 500 HP
- **Максимальное здоровье**: 500 HP
- **Урон**: 30
- **Радиус атаки**: 100 пикселей (или 250 пикселей в зависимости от уровня)
- **Защита**: 12
- **Уровень**: 1

**Расположение:**
- 6 башен на каждого игрока:
  - 2 башни по бокам центрального барака
  - 4 башни возле боковых бараков (по 2 с каждой стороны)

**Особенности:**
- Автоматически атакует ближайшего вражеского юнита в радиусе
- Интервал атаки: **1 секунда**
- Может быть улучшена до уровня 5

**Улучшение:**
- Стоимость: `уровень * 200` золота
- Каждый уровень:
  - +100 HP к максимальному здоровью
  - +10 к урону
- Кулдаун улучшения: 5 секунд

**Награда за разрушение**: 100 золота

---

## Боевая система

### Атаки между юнитами

#### Дистанция атаки

- **Ближний бой** (воин): 35 пикселей — юнит должен подойти вплотную
- **Дальний бой** (лучник, маг): 
  - Лучник: 180 пикселей (оптимальная: 108px)
  - Маг: 100 пикселей (оптимальная: 60px)

#### Механика атаки

1. **Поиск цели**: юнит ищет ближайшего вражеского юнита
2. **Проверка дистанции**: проверяется, находится ли враг в радиусе атаки
3. **Проверка интервала**: юнит может атаковать только раз в **1.5 секунды**
4. **Проверка движения**: юнит не может атаковать, пока движется
5. **Взаимная атака**: если оба юнита в радиусе атаки друг друга, оба наносят урон

#### Расчет урона

```typescript
фактический_урон = max(1, атака_атакующего - защита_защитника)
```

Минимальный урон всегда **1**, даже если защита больше атаки.

#### Пример боя

**Воин vs Лучник:**
- Воин (атака: 20, защита: 10) атакует лучника (защита: 5)
- Урон по лучнику: `20 - 5 = 15`
- Если лучник в радиусе атаки воина (35px), воин получает урон: `25 - 10 = 15`

**Лучник vs Воин (далеко):**
- Лучник (атака: 25, защита: 5) атакует воина (защита: 10) на дистанции 150px
- Урон по воину: `25 - 10 = 15`
- Воин НЕ получает урон, так как вне радиуса атаки (50px)

### Атаки зданий по юнитам

**Замок и башни** автоматически атакуют ближайших вражеских юнитов:

1. Поиск ближайшего врага в радиусе атаки
2. Проверка интервала: 1 секунда между атаками
3. Проверка линии обзора (в текущей версии отключена)
4. Нанесение урона

### Атаки юнитов по зданиям

Юниты могут атаковать здания на дистанции **60 пикселей**:

1. Поиск ближайшего вражеского здания
2. Подход на дистанцию 60px
3. Остановка и атака с интервалом **1.5 секунды**
4. Здание не может контратаковать (кроме замка и башен)

#### Урон по зданиям

```typescript
фактический_урон = max(1, атака_юнита - защита_здания)
```

### Блокировка атаки

В текущей версии проверка блокировки ландшафтом **отключена** (все зоны проходимы). Ранее существовали непроходимые зоны размером 80x80 пикселей, которые блокировали атаки насквозь.

---

## Движение юнитов

### Поиск целей

Юниты ищут цели в следующем приоритете:

1. **Вражеские юниты** — приоритет #1
2. **Вражеские здания** — приоритет #2
3. **Промежуточные цели** — если заданы (для обхода препятствий)
4. **Циклический маршрут** — движение по углам карты против часовой стрелки

### Маршрутизация

#### Промежуточные цели

Юниты могут иметь промежуточные точки маршрута:
- `intermediateTargets`: массив позиций
- `currentIntermediateIndex`: текущая промежуточная цель
- `finalTarget`: финальная цель после прохождения промежуточных

**Пример:** Юнит идет сначала в точку A, затем в точку B, затем к вражескому замку.

#### Циклический маршрут

Если нет врагов, юниты движутся по углам карты:
- Углы: (80, 80), (720, 80), (720, 720), (80, 720)
- Маршрут против часовой стрелки
- Если у ближайшего игрока нет зданий, переход к следующему игроку

### Оптимальная дистанция

**Дальнобойные юниты** (лучник, маг) останавливаются на **60% от максимального радиуса атаки**:
- Лучник: 180px → останавливается на 108px
- Маг: 100px → останавливается на 60px

**Ближний бой** (воин) подходит на **35 пикселей** и останавливается.

### Разделение юнитов

Юниты автоматически отталкиваются друг от друга на **5 пикселей**, чтобы предотвратить наложение друг на друга. Это учитывается при расчете дистанции атаки.

### Возобновление движения

Если юнит остановился для атаки, но враг ушел или погиб, юнит автоматически возобновляет движение и ищет новую цель.

---

## Экономика

### Источники золота

1. **Пассивный доход**: 
   - Базовая ставка: **10 золота в секунду**
   - Можно увеличить улучшением `goldIncome`
   - Каждый уровень: +5 золота в секунду

2. **Награды за убийство юнитов:**
   - Воин: 15 золота
   - Лучник: 20 золота
   - Маг: 25 золота
   - Награда получается **только убийцей** (игроком, чей юнит убил врага)

3. **Награды за разрушение зданий:**
   - Замок: 500 золота
   - Барак: 150 золота
   - Башня: 100 золота
   - Награда **разделяется поровну** между всеми игроками, чьи юниты находились в радиусе 60px от здания

### Расходы

1. **Покупка юнитов:**
   - Воин: 50 золота
   - Лучник: 75 золота
   - Маг: 100 золота

2. **Улучшения замка:**
   - Стоимость: `(текущий_уровень + 1) * 150`
   - Примеры:
     - Уровень 0 → 1: 150 золота
     - Уровень 1 → 2: 300 золота
     - Уровень 2 → 3: 450 золота

3. **Улучшение зданий:**
   - Стоимость: `уровень * 200`
   - Примеры:
     - Уровень 1 → 2: 200 золота
     - Уровень 2 → 3: 400 золота

4. **Починка зданий:**
   - Стоимость: 100 золота
   - Восстанавливает: 30% от максимального здоровья
   - Кулдаун: 10 секунд

---

## Система улучшений

### Улучшения замка (Castle Upgrades)

Игрок может улучшать 7 характеристик:

1. **Атака** (`attack`): увеличивает атаку всех юнитов на +10% за уровень
2. **Защита** (`defense`): увеличивает защиту всех юнитов на +10% за уровень
3. **Здоровье** (`health`): увеличивает здоровье всех юнитов на +15% за уровень
4. **Магия** (`magic`): в текущей версии не используется
5. **Доход золота** (`goldIncome`): +5 золота в секунду за уровень
6. **Здоровье зданий** (`buildingHealth`): +200 HP ко всем зданиям за уровень
7. **Атака зданий** (`buildingAttack`): +10 урона к атаке замка и башен за уровень

### Ограничения улучшений

- **Уровни 0-2**: без ограничений
- **Уровень 3+**: требуется замок минимум 2 уровня
- Максимальный уровень: **5** (для некоторых улучшений)

### Применение улучшений

**К новым юнитам:** улучшения применяются при создании юнита через множители.

**К существующим юнитам:**
- При улучшении **защиты** — все существующие юниты получают обновленную защиту
- При улучшении **здоровья зданий** — все здания получают +200 HP и восстанавливают здоровье
- При улучшении **атаки зданий** — замок и башни получают +10 урона

### Улучшение зданий

**Замок:**
- Улучшение до уровня 2: 200 золота
- +200 HP к максимальному здоровью
- Кулдаун: 5 секунд

**Бараки:**
- Каждый уровень: +100 HP, +2 к максимуму юнитов, -10% к времени спавна
- Максимум: уровень 5

**Башни:**
- Каждый уровень: +100 HP, +10 урона
- Максимум: уровень 5

---

## Автоматическое развитие

### Логика авторазвития

Для игрока 0 (верхний) авторазвитие включается/выключается флагом `autoUpgrade`. Для игроков 1-3 (ИИ) авторазвитие работает всегда.

**Приоритеты автоматического улучшения:**

#### Приоритет 1: Статы замка до уровня 1
Все статы (атака, защита, здоровье, доход, здоровье зданий, атака зданий) улучшаются до уровня 1:
- Проверка каждые 2 секунды
- Улучшается первая найденная характеристика ниже уровня 1
- Требуется достаточное количество золота

#### Приоритет 2: Бараки до уровня 2
После того, как все статы замка на уровне 1:
- Все бараки улучшаются до уровня 2
- По одному бару за раз

#### Приоритет 3: Статы замка до уровня 2
После того, как все бараки на уровне 2:
- Все статы замка улучшаются до уровня 2
- Требуется замок минимум 2 уровня для уровня 3+

#### Приоритет 4: Замок до уровня 2
Если все статы на уровне 2 и бараки на уровне 2, но замок еще на уровне 1:
- Замок улучшается до уровня 2

#### Приоритет 5: Случайное улучшение
После завершения базовых улучшений:
- Случайный выбор между:
  - Статами замка (до уровня 5)
  - Улучшением бараков (до уровня 5)
  - Улучшением башен (до уровня 5)

---

## Искусственный интеллект

### ИИ игроков (1-3)

ИИ игроки (ID: 1, 2, 3) принимают решения каждые **3 секунды**:

1. **40% шанс** — покупка юнита (если есть 200+ золота и доступные юниты)
   - Выбирается случайный живой барак
   - Покупается случайный доступный тип юнита

2. **30% шанс** — улучшение здания (если есть 200+ золота)
   - Выбирается случайное здание с уровнем < 5
   - Улучшается, если нет кулдауна

3. **30% шанс** — починка здания (если есть 100+ золота)
   - Выбирается случайное поврежденное здание
   - Чинится, если нет кулдауна

**Важно:** ИИ не покупает юнитов и не улучшает здания, если нет достаточного золота или все здания уже максимального уровня.

---

## Условия победы

### Проигрыш игрока

Игрок выбывает из игры (`isActive = false`), если у него:
- **Нет живых зданий** (замок, бараки и башни разрушены)
- **Нет живых юнитов**

### Конец игры

Игра заканчивается (`gameOver = true`), когда:

1. **Остался 1 активный игрок** → этот игрок побеждает
2. **Осталось 0 активных игроков** → ничья (`winner = null`)

### Статистика

Каждый игрок отслеживает:
- `unitsKilled` — количество убитых юнитов
- `unitsLost` — количество потерянных юнитов
- `buildingsDestroyed` — количество разрушенных зданий
- `buildingsLost` — количество потерянных зданий
- `damageDealt` — нанесенный урон
- `damageTaken` — полученный урон
- `goldEarned` — заработанное золото (включая награды)

---

## Технические детали

### Игровой цикл (Game Loop)

Основной цикл выполняется через `requestAnimationFrame` с учетом `gameSpeed`:

```typescript
const deltaTime = (now - lastUpdateTime) * gameSpeed;
```

**Последовательность обновления:**

1. Движение юнитов (с учетом промежуточных целей)
2. Разделение юнитов (отталкивание)
3. Атаки между юнитами
4. Атаки зданий по юнитам
5. Атаки юнитов по зданиям
6. Применение всех изменений к состоянию
7. Проверка условий победы
8. Обновление времени игры

### Параллельные процессы

**Спавн юнитов:**
- Интервал: 15 секунд (или меньше, если барак улучшен)
- Проверка для каждого барака отдельно

**Пассивный доход:**
- Интервал: 1 секунда
- Формула: `золото += (goldIncome * gameSpeed) / 10`

**Кулдауны:**
- Обновляются каждые 50мс в игровом цикле
- Уменьшаются на `deltaTime`

**Автоматическое развитие:**
- Проверка каждые 2 секунды
- Применяется к игроку 0 только если `autoUpgrade = true`

**ИИ решения:**
- Интервал: 3 секунды
- Только для игроков 1-3

---

## Константы игры

### Временные интервалы

- `UNIT_ATTACK_INTERVAL`: 1500мс (1.5 секунды между атаками юнитов)
- `BUILDING_ATTACK_INTERVAL`: 1000мс (1 секунда между атаками зданий)
- `ATTACK_ANIMATION_DURATION`: 300мс (длительность анимации атаки)
- `BUILDING_UPGRADE_COOLDOWN`: 5000мс (5 секунд кулдаун на улучшение)
- `UNIT_RESTORE_TIME`: 5000мс (5 секунд на восстановление юнита в бараке)
- `REPAIR_COOLDOWN`: 10000мс (10 секунд кулдаун на починку)

### Дистанции

- `MELEE_DISTANCE`: 35px (дистанция ближнего боя)
- `RANGED_THRESHOLD`: 80px (порог для определения дальнобойного юнита)
- `OPTIMAL_RANGE_MULTIPLIER`: 0.6 (60% от радиуса для оптимальной дистанции)
- `BUILDING_TARGET_DISTANCE`: 50px (здание считается в позиции)
- `UNIT_ATTACK_BUILDING_DISTANCE`: 60px (дистанция атаки юнита по зданию)

### Экономика

- `STAT_UPGRADE_COST_MULTIPLIER`: 150 (стоимость улучшения стата)
- `BUILDING_UPGRADE_COST_MULTIPLIER`: 200 (стоимость улучшения здания)
- `GOLD_INCOME_PER_LEVEL`: 5 (дополнительное золото в секунду за уровень)
- `HEALTH_BONUS_PER_LEVEL`: 200 (бонус здоровья зданий за уровень)
- `ATTACK_BONUS_PER_LEVEL`: 10 (бонус атаки зданий за уровень)

---

## Заключение

Игра "Survival Chaos" представляет собой комплексную стратегическую систему с множеством взаимодействующих механик. Понимание всех описанных выше аспектов необходимо для эффективного игрового процесса и дальнейшей разработки игры.

